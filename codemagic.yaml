workflows:
  react-native-ios:
    name: iOS Production Build
    instance_type: mac_mini_m1
    environment:
      groups:
        - ios_certificates_group  # éœ€è¦åœ¨Codemagicåå°é…ç½®è¯ä¹¦å’Œæè¿°æ–‡ä»¶
      vars:
        APP_ID: "00008110-0004513A3686201E"  # æ›¿æ¢ä¸ºå®é™…Bundle ID
        SCHEME_NAME: "JuZi"  # æ›¿æ¢ä¸ºå®é™…Schemeåç§°
        RUBY_VERSION: "3.2.2"
        COCOAPODS_VERSION: "1.15.2"
    scripts:
      # ================= ç¯å¢ƒå‡†å¤‡é˜¶æ®µ =================
      - name: Configure Environment
        script: |
          # ç¦ç”¨Homebrewå¹²æ‰°é¡¹
          export HOMEBREW_NO_INSTALL_CLEANUP=1
          export HOMEBREW_NO_ENV_HINTS=1
          echo "âœ… å·²ç¦ç”¨Homebrewå¹²æ‰°è®¾ç½®"

      # ================= ä¾èµ–å®‰è£…é˜¶æ®µ =================
      - name: Install System Dependencies
        script: |
          # å®‰è£…å¿…éœ€çš„ç³»ç»Ÿåº“
          brew install openssl@1.1 readline libyaml libffi
          
          # è®¾ç½®åŠ¨æ€åº“è·¯å¾„ï¼ˆå…¼å®¹M1å’ŒIntelèŠ¯ç‰‡ï¼‰
          echo "export LDFLAGS=\"-L/opt/homebrew/opt/libffi/lib -L$(brew --prefix openssl@1.1)/lib \$LDFLAGS\"" >> ~/.zshrc
          echo "export CPPFLAGS=\"-I/opt/homebrew/opt/libffi/include -I$(brew --prefix openssl@1.1)/include \$CPPFLAGS\"" >> ~/.zshrc
          source ~/.zshrc
          
          echo "ğŸ”§ ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      # ================= Rubyç¯å¢ƒé…ç½® =================
      - name: Setup Ruby Environment
        script: |
          # å®‰è£…rbenv
          git clone https://github.com/rbenv/rbenv.git ~/.rbenv
          echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.zshrc
          echo 'eval "$(rbenv init -)"' >> ~/.zshrc
          source ~/.zshrc
          
          # å®‰è£…ruby-buildæ’ä»¶
          mkdir -p ~/.rbenv/plugins
          git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
          
          # é…ç½®ç¼–è¯‘å‚æ•°
          export RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@1.1) --with-libffi-dir=$(brew --prefix libffi) --enable-shared"
          
          # å®‰è£…æŒ‡å®šRubyç‰ˆæœ¬
          if ! rbenv install $RUBY_VERSION; then
            echo "âŒ Rubyå®‰è£…å¤±è´¥ï¼Œå°è¯•æ¸…é™¤ç¼“å­˜åé‡è¯•..."
            rm -rf ~/.rbenv/versions/$RUBY_VERSION
            rbenv install $RUBY_VERSION || { echo "âŒ Rubyå®‰è£…æœ€ç»ˆå¤±è´¥"; exit 1; }
          fi
          
          rbenv global $RUBY_VERSION
          echo "ğŸ’ Ruby $RUBY_VERSION å®‰è£…æˆåŠŸ"

      # ================= Cocoapodsé…ç½® =================
      - name: Install Cocoapods
        script: |
          # é…ç½®Gemç¯å¢ƒ
          export GEM_HOME="$HOME/.gem"
          export PATH="$GEM_HOME/bin:$PATH"
          
          # å®‰è£…æŒ‡å®šç‰ˆæœ¬Cocoapods
          gem install cocoapods -v $COCOAPODS_VERSION -- \
            --with-ldflags="-L/opt/homebrew/opt/libffi/lib" \
            --with-cppflags="-I/opt/homebrew/opt/libffi/include" \
            --no-document
          
          # éªŒè¯å®‰è£…
          if ! pod --version | grep -q $COCOAPODS_VERSION; then
            echo "âŒ Cocoapodsç‰ˆæœ¬ä¸åŒ¹é…"
            exit 1
          fi
          echo "ğŸ“¦ Cocoapods $COCOAPODS_VERSION å®‰è£…æˆåŠŸ"

      # ================= é¡¹ç›®æ„å»ºé˜¶æ®µ =================
      - name: Build iOS Project
        script: |
          # è¿›å…¥iOSç›®å½•
          cd ios
          
          # å®‰è£…é¡¹ç›®ä¾èµ–
          pod install --repo-update || { echo "âŒ Podå®‰è£…å¤±è´¥"; exit 1; }
          
          # æ¸…ç†æ„å»ºç¼“å­˜
          xcodebuild clean -workspace JuZi.xcworkspace -scheme JuZi
          
          # å½’æ¡£é¡¹ç›®
          xcodebuild archive \
            -workspace JuZi.xcworkspace \
            -scheme JuZi \
            -archivePath $CM_BUILD_DIR/build/JuZi.xcarchive \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_STYLE="Manual" \
            PROVISIONING_PROFILE_SPECIFIER="$IOS_PROVISIONING_PROFILE" \
            DEVELOPMENT_TEAM="$IOS_DEVELOPMENT_TEAM" \
            PRODUCT_BUNDLE_IDENTIFIER="$APP_ID" \
            | xcpretty
          
          # å¯¼å‡ºIPA
          xcodebuild -exportArchive \
            -archivePath $CM_BUILD_DIR/build/JuZi.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath $CM_BUILD_DIR/build/artifacts \
            | xcpretty
          
          echo "ğŸ“± æ„å»ºæˆåŠŸï¼IPAæ–‡ä»¶è·¯å¾„: $CM_BUILD_DIR/build/artifacts"

      # ================= åç»­å¤„ç†é˜¶æ®µ =================
      - name: Post-build Checks
        script: |
          # éªŒè¯äº§ç‰©å­˜åœ¨æ€§
          if [ ! -f "$CM_BUILD_DIR/build/artifacts/JuZi.ipa" ]; then
            echo "âŒ IPAæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          /usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" ios/JuZi/Info.plist
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

    artifacts:
      - build/artifacts/**/*.ipa
    publishing:
      email:
        recipients:
          - dev-team@yourcompany.com
